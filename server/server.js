(()=>{"use strict";var e={168:e=>{e.exports=require("koa-sslify")}},t={};function a(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,a),n.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={};a.r(e),a.d(e,{clearToken:()=>Ee,getMyChapters:()=>Re,getMyCourseList:()=>Ae,getMyOrder:()=>ve,getMyProgressInfo:()=>he,getMySubscribe:()=>De,getUserData:()=>be,restoreToken:()=>me,saveToken:()=>ge,setMyChapters:()=>Ce,setMyCourseList:()=>fe,setMyCurSubscribe:()=>we,setMyOrder:()=>Ne,setMyProgressInfo:()=>Ie,setMySubscribe:()=>_e,setToken:()=>ye,setUserData:()=>pe,submitMySubscribe:()=>Se});var t={};a.r(t),a.d(t,{getAllBanner:()=>Me,getAllCategory:()=>ke,getAllSubscribeData:()=>Pe,getHotKeywords:()=>Fe,getSiteLink:()=>Ke,getSuggest:()=>He,getTopics:()=>$e,setAllBanner:()=>Oe,setAllCategory:()=>Te,setAllSubscribeData:()=>We,setHotKeywords:()=>Le,setSiteLink:()=>Ue,setSuggest:()=>qe,setTopics:()=>xe});var r={};a.r(r),a.d(r,{hideAlert:()=>Je,setFooterVisible:()=>je,setHeaderVisible:()=>Ve,setSearchBarKw:()=>Ye,showAlert:()=>Be});var s={};a.r(s),a.d(s,{addMyProgress:()=>ut,getAdList:()=>at,getCourseDetail:()=>it,getCourseRegisted:()=>st,getIndexCourseSummary:()=>Ge,getSearchCategoryData:()=>et,getSearchCourse:()=>Xe,getVideoSectionData:()=>ot,registerCourse:()=>lt,setAdList:()=>tt,setCourseDetail:()=>nt,setCourseRegisted:()=>rt,setIndexCourseSummary:()=>ze,setSearchCategoryData:()=>Ze,setSearchCourseResult:()=>Qe,setVideoSectionData:()=>ct});const n=require("koa");var i=a.n(n);const c=require("https");var o=a.n(c);const l=require("fs");var u=a.n(l);const d=a(168).default,y=new(i());y.use(d());var g={key:u().readFileSync("src/keys/private_key.pem"),cert:u().readFileSync("src/keys/ca-cert.pem")};o().createServer(g,y.callback()).listen(7070,(()=>{console.log("server start at localhost:7070")}));const m=y,E=require("@koa/router");var p=a.n(E);const b=require("mysql2/promise");const _=a.n(b)().createPool({host:"82.156.109.119",port:3306,user:"xiaoshuai",password:"DTxjyNCWjz5t8RDn",database:"lsbts"}),D=new class{db;constructor(e){this.db=e}async query(e,t){try{return(await this.db.query(e,t))[0]}catch(e){throw console.log(JSON.stringify(e)),e}}async execute(e,t){return(await this.db.execute(e,t))[0]}async all(e,t,a){return t?await this.query("\n            SELECT * FROM ?? ORDER BY ?? "+("asc"==a?"ASC":"DESC"),[e,t,a]):await this.query("SELECT * FROM ??",[e])}async one(e,t){return(await this.query(e,t))[0]}async count(e,t,a){return a||(a=[]),t?await this.one(`SELECT COUNT(*) AS count FROM ?? WHERE ${t} `,[e,...a]):await this.one("SELECT COUNT(*) AS count FROM ??",[e])}}(_),S=require("redis");var w=a.n(S);const I=require("util"),h=require("path");var f=a.n(h);const A=f().resolve(__dirname,"../build"),C=f().resolve(__dirname,"../log/error.log"),R="KEY_APP_CATEGORY_CACHE",N="KEY_APP_ALL_SUBSCRIBE_CACHE",v="KEY_APP_TOPICS";let T=w().createClient({host:"82.156.109.119",port:6379,username:"xiaoshuai",password:"sdl@admin"});const k=(0,I.promisify)(T.get).bind(T),O=(0,I.promisify)(T.set).bind(T);async function M(e){{let t=await k(e);if(t)try{return JSON.parse(t)}catch(e){}}}async function L(e,t){await O(e,JSON.stringify(t))||console.error("SetRedisCache Failed!")}async function F(){let e=await M(R);if(e)return e;let t=[],a=await D.all("category_table","parent_id","asc"),r=await D.all("category_item_table","category_id","asc");return a.forEach((e=>{let a={ID:e.ID,title:e.title};const{parent_id:r}=e;if(0===r)t.push(a);else{let e=t.find((e=>e.ID===r));e&&(e.children=e.children||[],e.children.push(a))}})),r.forEach((e=>{let r={ID:e.ID,title:e.title};const{category_id:s}=e;t.forEach((e=>{let t=e.children?.find((e=>e.ID===s));t&&(t.children||(t.children=[]),t.children.push(r))}));{let e=a.find((e=>e.ID===s));if(e){let s=a.find((t=>t.ID===e?.parent_id)),n=t.find((e=>e.ID===s?.ID));n&&(n.items=n.items||[]),n?.items&&n?.items?.length<3&&n.items.push(r)}}})),await L(R,t),t}let q=new(p());q.prefix("/category"),q.get("/getCategories",(async e=>{let t=await F();e.body=t}));const H=q.routes();function W(e){return new Promise(((t,a)=>{try{e.req.addListener("data",(e=>{var a=JSON.parse(e);t(a)}))}catch(e){a(e)}}))}async function P(e,t){t||(t=0);const a=await D.query("SELECT * FROM course_chapter_table WHERE course_id=?",[e]),r=await D.query("\n    SELECT\n        section.*,progress.time\n    FROM\n        course_section_table AS section LEFT JOIN\n        course_progress_table AS progress ON progress.course_section_id=section.ID\n    WHERE\n    section.course_id=?",[e]),s=await D.query("SELECT * FROM course_progress_table WHERE course_id=? AND user_id=?",[e,t]),n=[];a.forEach((e=>{n.push({ID:e.ID,progress:0,title:e.title,sections:[]})}));let i={};r.forEach((({item_id:e,type:t})=>{i[t]||(i[t]=[]),i[t].push(e)}));let c={video:"ID,videoID,duration",live:"ID,liveID,start_time,end_time",read:"ID",download:"ID,fileID,size"},o={};for(let e in i)o[e]=await D.query(`SELECT ${c[e]} FROM course_${e}_table WHERE ID IN (${i[e].join(",")})`);return r.forEach((({ID:e,title:t,type:a,item_id:r,chapter_id:i,time:c})=>{let l=n.find((e=>e.ID===i)),u=o[a].find((e=>e.ID===r));if(l){let r=0;if("video"===a){let t=s.find((t=>t.course_section_id===e));t&&u&&(r=Math.min(1,Math.round(100*t.progress/u.duration)/100))}else r=1;l.sections.push({ID:e,title:t,type:a,progress:r,item:u,time:c})}})),n.forEach((e=>{let t=0;e.sections.forEach((e=>{t+=e.progress})),e.progress=Math.min(1,Math.round(100*t/e.sections.length)/100)})),n}const x=require("crypto");var $=a.n(x);function U(e,t,a){if(e)throw{code:t,msg:a}}const K=require("url");var B=a.n(K);async function J(e,t){let{count:a}=await D.one("\n     SELECT COUNT(*) AS count FROM pay_table WHERE course_id=? AND user_id=?\n     ",[e,t]);return a>0}async function Y(e){return(await D.query("\n    SELECT \n    keyword \n    FROM search_record_table \n    WHERE keyword LIKE ?\n    ORDER BY count DESC\n    LIMIT 5",[e+"%"])).map((e=>e.keyword))}async function V(e){if(e){let{ID:t}=await D.one("SELECT ID FROM user_table WHERE token=?",[e]);return t||0}return 0}let j=new(p());j.prefix("/course"),j.get("/index-course-list",(async e=>{const{category:t}=e.query;"string"==typeof t&&(e.body=await async function(e,t){return await D.query("\n   SELECT \n        course.ID, course.title,course.cover,course.price,course.agency_id,\n        agency.name AS agency_name,\n        0 AS recent_order_count,\n        0 AS section_count\n   FROM \n        course_table AS course LEFT JOIN\n        agency_table AS agency ON course.agency_id=agency.ID\n    WHERE\n        category_id_1=?\n\n   LIMIT\n        20\n   ",[e])}(parseInt(t)))})),j.get("/get-category-options",(async e=>{let t=e.query.category?Number(e.query.category):0,a=e.query.category_level?Number(e.query.category_level):0;e.body=t&&a?await async function(e,t){return U("number"!=typeof e,400,"request arguments invaild 1"),U("number"!=typeof t,400,"request arguments invaild 2"),U(1!=t&&2!=t&&3!=t,400,"request arguments invaild 3"),(await D.query("\n      SELECT * FROM\n        category_tags_table\n      WHERE\n        category_id=? AND category_level=?\n      ORDER BY\n        sort ASC\n    ",[e,t])).map((e=>({key:e.ID,title:e.title,options:e.options.split(","),allow_multi:1==e.allow_multi})))}(t,a):[]})),j.post("/search",(async e=>{var t=await W(e);e.body=await async function(e){const t="KEY_APP_SEARCH_PRE_"+JSON.stringify(e);let a=await M(t);if(a)return a;const{category:r,category_level:s,keyword:n,page:i,categories:c}=e;let o=[];if(r&&s&&"0"!=r.toString()&&"0"!=s.toString()&&o.push(`category_id_${s}=${r}`),n){let e=n.split(/\s+/),t=[];e.forEach((e=>{t.push(`title LIKE '%${e}%'`)})),o.push("("+t.join(" OR ")+")")}const{filter:l}=e,{type:u,sort:d}=l;"free"===u?o.push("price=0"):u&&o.push("price>0");let y=o.join(" AND "),g="";y&&(g=` WHERE ${y}`);let m="";"default"!==d&&"students"!==d&&(m="rank"===d?` ORDER BY course.${d} DESC`:` ORDER BY ${d} DESC`);let E=`\n    SELECT \n         course.ID, course.title,course.cover,course.price,course.agency_id,tags,\n         agency.name AS agency_name,\n         0 AS recent_order_count,\n         0 AS section_count\n    FROM \n         course_table AS course LEFT JOIN\n         agency_table AS agency ON course.agency_id=agency.ID\n         ${g} \n         ${m}\n         `,p=await D.query(E);p=p.filter((e=>{let t=JSON.parse(e.tags),a={};for(let e in t)a[e]=t[e].split(",");return function(e,t){for(let a in e){if(!t[a])return!1;for(let r=0;r<e[a].length;r++){let s=e[a][r];if(-1===t[a].indexOf(s))return!1}}return!0}(c,a)}));let b=p.length,_=24*(i-1),S={data:p.slice(_,24),total:b};return await L(t,S),S}(t)})),j.get("/ad",(async e=>{const{type:t}=e.query;let a;"right"!==t&&"bottom"!==t||(a=await async function(e){return await D.query("\n    SELECT\n        course.ID,course.title,course.cover,course.price,\n        course.agency_id,agency.name AS agency_name\n    FROM\n        ad_table AS ad\n        LEFT JOIN course_table AS course\n            ON ad.course_id=course.ID\n        LEFT JOIN agency_table AS agency\n            ON course.agency_id=agency.ID\n    WHERE\n        ad.type=?\n    ",[e])}(t)),e.body={type:t,data:a}})),j.get("/is-registed/:courseID",(async e=>{const t=await V(e.get("token")),a=Number(e.params.courseID);e.body=await J(a,t)})),j.get("/detail/:courseID",(async e=>{const t=Number(e.params.courseID);let a=await async function(e){const t="KEY_COURSE_DETAIL_PRE"+e;let a=await M(t);if(a)return a;const r=await D.one("SELECT * FROM course_table WHERE ID=?",[e]),s={ID:r.ID,cover:r.cover,title:r.title,price:r.price,total_students:0,recently_students:0,rank:r.rank,summary:r.summary,description:r.description},n=(await D.query(`SELECT * FROM teacher_table WHERE ID IN (${r.teachers})`)).map((({ID:e,name:t,title:a,summary:r,avatar:s})=>({ID:e,name:t,title:a,summary:r,avatar:s}))),i=await D.one("SELECT * FROM category_table WHERE ID=?",[r.category_id_1]),c=await D.one("SELECT * FROM category_table WHERE ID=?",[r.category_id_2]),o=await D.one("SELECT * FROM category_item_table WHERE ID=?",[r.category_id_3]),l=[{ID:r.category_id_1,title:i.title},{ID:r.category_id_2,title:c.title},{ID:r.category_id_3,title:o.title}],u=await D.one("SELECT * FROM agency_table WHERE ID=?",[r.agency_id]),{count:d}=await D.count("course_table","agency_id=?",[u.ID]),{count:y}=await D.count("pay_table","agency_id=?",[u.ID]);return a={course:s,teachers:n,category:l,agency:{avatar:u.logo,agency_name:u.name,agency_rank:u.rank,summary:u.summary,total_course:d,total_students:y},chapters:await P(e),comments:(await D.query("SELECT * FROM course_comment_table WHERE course_id=?",[e])).map((({ID:e,rank:t,time:a,course_time:r,content:s,avatar:n,nickname:i})=>({ID:e,rank:t,time:a,course_time:r,content:s,avatar:n,nickname:i})))},await L(t,a),a}(t);e.body=a})),j.get("/video-section/:sectionID",(async e=>{const t=Number(e.params.sectionID),a=await V(e.get("token"));e.body=await async function(e,t){const a=await D.one("SELECT * FROM course_section_table WHERE type=? AND ID=?",["video",e]);U(!a,404,"请先观看录播视频"),U(!await J(a.course_id,t),403,"需要报名课程后查看");const r=await D.one("SELECT * FROM course_video_table WHERE ID=?",[a.item_id]);U(!r,404,"视频不存在或已被删除");const{videoID:s,duration:n}=r,i=Math.floor(Date.now()/1e3+2*n).toString(16),c=(o=f().parse(B().parse(s).path||"").dir+"/"+i,$().createHash("md5").update(o).digest("hex"));var o;return{section_title:a.title,videoLink:`${s}?t=${i}&sign=${c}`}}(t,a)})),j.get("/regist/:courseID",(async e=>{const t=Number(e.params.courseID),a=await V(e.get("token"));await async function(e,t){let a=await D.one("SELECT * FROM course_table WHERE ID=?",[e]);U(!a,400,"报名的课程不存在，请刷新重试"),U(!await D.count("user_table","ID=?",[t]),400,"用户数据有误，请重新登录");let{count:r}=await D.count("pay_table","course_id=? AND user_id=? AND status='success'",[e,t]);U(0!==r,400,"已报名过，请勿重复报名"),await D.query("\n       INSERT INTO pay_table\n       (order_id, serial_number, time, status, agency_id, course_id, user_id, amount)\n       VALUES('0', '0', ?, 'success', ?, ?, ?, ?)\n       ",[Math.floor(Date.now()/1e3),a.agency_id,e,t,a.price])}(t,a),e.body="ok"})),j.get("/add-progress/:sectionID",(async e=>{const t=Number(e.params.sectionID),a=await V(e.get("token"));await async function(e,t){let a=await D.one("SELECT * FROM course_section_table WHERE ID=?",[e]);U(!a,400,"章节不存在，请刷新重试"),U(!("video"===a.type),400,"视频类型有误，请刷新重试"),U(!await D.one("SELECT * FROM pay_table WHERE course_id=? AND user_id=?",[a.course_id,t]),400,"此课程未报名，请报名后重试");let r=await D.one("SELECT * FROM course_progress_table WHERE course_section_id=? AND user_id=?",[e,t]);r?await D.query("UPDATE course_progress_table SET progress=progress+30 WHERE ID=?",[r.ID]):await D.query("\n         INSERT INTO course_progress_table\n         (\n           user_id, course_id, course_chapter_id, course_section_id, progress, time\n         )\n         VALUE(\n           ?, ?, ?, ?, ?, ?\n         )\n         ",[t,a.course_id,a.chapter_id,e,30,Math.floor(Date.now()/1e3)]);let s=new Date,n=Number(s.getFullYear()+(s.getMonth()+1).toString().padStart(2,"0")+s.getDate().toString().padStart(2,"0")),i=await D.one("SELECT * FROM user_points_table WHERE user_id=? AND date=?",[t,n]);if(i){let e=Math.min(50,(i.studyTime+30)/120),a=e-i.points;await D.query("UPDATE user_points_table SET studyTime=studyTime+30, points=? WHERE ID=?",[e,i.ID]),a&&await D.query("UPDATE user_table SET points=points+? WHERE ID=?",[a,t])}else{let e=Math.floor(.25);await D.query("INSERT INTO user_points_table (user_id, date, studyTime, points) VALUE(?,?,?,?)",[t,n,30,e]),e&&await D.query("UPDATE user_table SET points=points+? WHERE ID=?",[e,t])}}(t,a),e.body="ok"}));const z=j.routes();async function G(){return await D.all("banner_table","sort","asc")}async function Q(){let e=await M("KEY_APP_SITELINK");return e||(e=(await D.all("site_link_table","sort","asc")).map((e=>({ID:e.ID,title:e.title,href:e.href}))),e)}async function X(){let e=await M(v);if(e)return e;let t=await D.all("topic_table","sort","asc"),a=await D.all("topic_item_table","sort","asc");return e=t.map((e=>({ID:e.ID,title:e.title,children:[]}))),a.forEach((t=>{let a=e.find((e=>e.ID===t.topic_id));a&&a.children?.push({ID:t.ID,title:t.title})})),L(v,e),e}let Z=new(p());Z.prefix("/site"),Z.get("/getCategories",(async e=>{let t=await F();e.body=t})),Z.get("/getHotKeyWords",(async e=>{let t=await Y("");e.body=t})),Z.get("/getSuggest/:kw",(async e=>{const{kw:t}=e.params;let a=await Y(t);e.body=a})),Z.get("/getAllBanners",(async e=>{let t=await G();e.body=t})),Z.get("/getAllSubscibe",(async e=>{let t=await async function(){let e=await M(N);return e||(e=[],(await D.all("category_table","parent_id","asc")).forEach((t=>{0==t.parent_id?e.push({ID:t.ID,title:t.title,children:[]}):e.find((e=>e.ID==t.parent_id))?.children?.push({ID:t.ID,title:t.title})}))),await L(N,e),e}();e.body=t})),Z.get("/getTopics",(async e=>{let t=await X();e.body=t})),Z.get("/getSiteLink",(async e=>{let t=await Q();e.body=t}));const ee=Z.routes();let te=new(p());te.prefix("/user"),te.get("/userCheck",(async e=>{const t=e.URL.searchParams.get("nickname");if(t){let a=await async function(e){let t=await D.query("\n    SELECT \n    token \n    FROM user_table \n    WHERE nickname=?\n    ",[e]);if(t.length>0){let e={token:""};return e.token=t[0].token,e}return{token:""}}(t);e.body=a}else e.body={token:""}})),te.post("/userAdd",(async e=>{var t=await W(e);if(t){let a=await async function(e){return!!await D.execute("\n    INSERT INTO user_table\n    (nickname,avatar,token,qq_unionid,points,currentcy,mobile,address,blocked)\n    VALUES \n    (?,?,?,'',0,0,'','',0)\n    ",[e.nickname,e.avatar,e.token])}(t);e.body=a}else e.body=!1})),te.get("/getUserInfo",(async e=>{const t=e.get("token");if(t){let a=await async function(e){return(await D.query("\n    SELECT \n    ID,avatar,nickname,points,currency\n    FROM user_table \n    WHERE token=?\n    ",[e]))[0]}(t);a?e.body=a:(e.status=404,e.body="Not Found")}else e.body=""})),te.get("/mysubscribe",(async e=>{let t=await V(e.get("token"));e.body=await async function(e){let t=(await D.query("SELECT category_id FROM user_subscribe_table WHERE user_id=?",[e]))[0],a=[{ID:0,title:"精选推荐"}];if(t){let e=JSON.parse(t.category_id);for(let t=0;t<e.length;t++){let r=await D.query("SELECT ID,title FROM category_table WHERE ID=?",e[t]);a.push(r[0])}}else a.push({ID:2,title:"前端"},{ID:3,title:"后端"},{ID:8,title:"面试求职"});return a}(t)})),te.post("/setMysubscribe",(async e=>{let t=await V(e.get("token"));var a=await W(e);await async function(e,t){U(!e,401,"请先登录再设置"),U(0===(await D.query("SELECT * FROM user_table WHERE ID=?",[e])).length,400,"数据异常请重新登录"),U(!(t instanceof Array),400,"数据异常刷新重试");{let a,r=[];for(let e=1;e<t.length;e++)r.push(t[e].ID);a=(await D.query("SELECT * FROM user_subscribe_table WHERE user_id=?",[e]))[0].ID?await D.execute("\n    UPDATE  user_subscribe_table\n    SET category_id=?\n    WHERE user_id=?\n    ",[r,e]):await D.execute("\n    INSERT INTO user_subscribe_table\n    (user_id,category_id)\n    VALUES \n    (?,?)\n    ",[e,r])}}(t,a),e.body="OK"})),te.get("/my-progress-info",(async e=>{let t=await V(e.get("token"));e.body=await async function(e){let t=new Date,a=Number(t.getFullYear()+(t.getMonth()+1).toString().padStart(2,"0")+t.getDate().toString().padStart(2,"0"));const{points:r}=await D.one("SELECT points FROM user_table WHERE ID=?",[e]),s=await D.one("SELECT studyTime,points FROM user_points_table WHERE user_id=? AND date=?",[e,a]);let n=0,i=0;s&&(n=s.studyTime,i=s.points);const{count:c}=await D.one("SELECT COUNT(*) AS count  FROM user_points_table WHERE studyTime>? AND date=?",[n,a]),{count:o}=await D.count("user_table");return{points:r,todayCourseRank:Math.round((o-c)/o*1e3)/1e3,todayPoints:i,todayCourseSec:n}}(t)})),te.get("/my-course-list",(async e=>{let t=await V(e.get("token"));e.body=await async function(e){return await D.query("\n    SELECT\n        course.ID,course.title,course.expires,\n        0 AS progress\n    FROM\n        pay_table AS pay LEFT JOIN\n        course_table AS course ON pay.course_id=course.ID\n    WHERE\n        pay.status='success' AND pay.user_id=?\n    ",[e])}(t)})),te.get("/chapters/:courseID",(async e=>{let t=await V(e.get("token")),a=Number(e.params.courseID);e.body=await P(a,t)})),te.get("/my-orders",(async e=>{let t=await V(e.get("token"));e.body=await async function(e){return(await D.query("\n        SELECT\n          pay.ID,\n          pay.time,\n          agency.name AS agency_name,\n  \n          course.ID AS course_id,\n          course.cover,\n          course.title,\n          '' AS className,\n          course.price,\n          pay.status\n        FROM\n          pay_table AS pay LEFT JOIN\n          agency_table AS agency ON pay.agency_id=agency.ID LEFT JOIN\n          course_table AS course ON pay.course_id=course.ID\n        WHERE\n          pay.user_id=?\n  \n        ORDER BY pay.time DESC\n      ",[e])).map((e=>({ID:e.ID,time:e.time,agency_name:e.agency_name,courses:[{ID:e.course_id,cover:e.cover,title:e.title,className:e.className,price:e.price,status:e.status}]})))}(t)}));const ae=te.routes();let re=new(p());re.prefix("/api"),re.get("/getAPI",(async e=>{e.body=[{name:"banners"},{name:"users"}]})),re.use(H),re.use(z),re.use(ee),re.use(ae);const se=re.routes(),ne=require("react");var ie=a.n(ne);const ce=require("react-dom/server");var oe=a.n(ce);let le;le="undefined"!=typeof window?window.appData:{};const ue=require("react-redux"),de=require("@reduxjs/toolkit"),ye=(0,de.createAction)("setToken"),ge=(0,de.createAction)("saveToken"),me=(0,de.createAction)("restoreToken"),Ee=(0,de.createAction)("clearToken"),pe=(0,de.createAction)("setUserData"),be=(0,de.createAction)("getUserData"),_e=(0,de.createAction)("setMySubscribe"),De=(0,de.createAction)("getMySubscribe"),Se=(0,de.createAction)("submitMySubscribe"),we=(0,de.createAction)("setMyCurSubscribe"),Ie=(0,de.createAction)("setMyProgressInfo"),he=(0,de.createAction)("getMyProgressInfo"),fe=(0,de.createAction)("setMyCourseList"),Ae=(0,de.createAction)("getMyCourseList"),Ce=(0,de.createAction)("setMyChapters"),Re=(0,de.createAction)("getMyChapters"),Ne=(0,de.createAction)("setMyOrder"),ve=(0,de.createAction)("getMyOrder"),Te=(0,de.createAction)("setAllCategory"),ke=(0,de.createAction)("getAllCategory"),Oe=(0,de.createAction)("setAllBanner"),Me=(0,de.createAction)("getAllBanner"),Le=(0,de.createAction)("setHotKeywords"),Fe=(0,de.createAction)("getHotKeywords"),qe=(0,de.createAction)("setSuggest"),He=(0,de.createAction)("getSuggest"),We=(0,de.createAction)("setAllSubscribeData"),Pe=(0,de.createAction)("getAllSubscribeData"),xe=(0,de.createAction)("setTopics"),$e=(0,de.createAction)("getTopics"),Ue=(0,de.createAction)("setSiteLink"),Ke=(0,de.createAction)("getSiteLink"),Be=(0,de.createAction)("showAlert"),Je=(0,de.createAction)("hideAlert"),Ye=(0,de.createAction)("setSearchBarKw"),Ve=(0,de.createAction)("setHeaderVisible"),je=(0,de.createAction)("setFooterVisible"),ze=(0,de.createAction)("setIndexCourseSummary"),Ge=(0,de.createAction)("getIndexCourseSummary"),Qe=(0,de.createAction)("setSearchCourseResult"),Xe=(0,de.createAction)("getSearchCourse"),Ze=(0,de.createAction)("setSearchCategoryData"),et=(0,de.createAction)("getSearchCategoryData"),tt=(0,de.createAction)("setAdList"),at=(0,de.createAction)("getAdList"),rt=(0,de.createAction)("setCourseRegisted"),st=(0,de.createAction)("getCourseRegisted"),nt=(0,de.createAction)("setCourseDetail"),it=(0,de.createAction)("getCourseDetail"),ct=(0,de.createAction)("setVideoSectionData"),ot=(0,de.createAction)("getVideoSectionData"),lt=(0,de.createAction)("registerCourse"),ut=(0,de.createAction)("addProgress"),dt={user:e,site:t,app:r,course:s},yt=(0,ue.connect)((e=>e))((function(e){const t=le.banners||e.site.BannerData,[a,r]=(0,ne.useState)(0);return t||e.dispatch(dt.site.getAllBanner()),ie().createElement("div",{className:"banner",style:{backgroundColor:t?t[a].color:"#000"}},ie().createElement("div",{className:"page"},ie().createElement("div",{className:"content"},ie().createElement("span",{className:"btn btn-prev",onClick:()=>{t&&r(0===a?t.length-1:a-1)}},ie().createElement("i",{className:"icon icon-left-w"})),ie().createElement("span",{className:"btn btn-next",onClick:()=>{t&&r(a===t.length-1?0:a+1)}},ie().createElement("i",{className:"icon icon-right-w"})),t?ie().createElement(ie().Fragment,null,ie().createElement("ul",{className:"banner-list"},t.map(((e,t)=>ie().createElement("li",{key:e.ID,className:t===a?"active":""},ie().createElement("a",{href:e.href},ie().createElement("img",{src:e.img,alt:""})))))),ie().createElement("ol",{className:"indicator-list"},t.map(((e,t)=>ie().createElement("li",{key:e.ID,className:t===a?"active":""}))))):""),ie().createElement("div",{className:"user"},ie().createElement("div",{className:"no-user"},ie().createElement("div",{className:"title"},"跟进你的学习进度"),ie().createElement("div",{className:"img"})),ie().createElement("div",{className:"login"},ie().createElement("a",{className:"btn-login",href:"https://graph.qq.com/oauth2.0/show?which=Login&display=pc&client_id=101995223&response_type=token&scope=all&redirect_uri=https%3A%2F%2Fxscloud.ltd%2Fgames"},"登录")))))})),gt=(0,ue.connect)((e=>e))((function(e){const[t,a]=(0,ne.useState)(e.user?.mySubscribe?[...e.user?.mySubscribe]:[]),r=e.site?.SubscribeData;r||e.dispatch(dt.site.getAllSubscribeData()),t||e.dispatch(dt.user.getMySubscribe());const s=e=>!!t&&t.find((t=>t.ID===e.ID)),n=[[],[]];return r?.forEach(((e,t)=>{n[t%2].push(e)})),ie().createElement(ie().Fragment,null,ie().createElement("div",{className:"g-subscribe-shadow",onClick:e.onClose}),ie().createElement("div",{className:"g-subscribe-dialog"},ie().createElement("h3",{className:"title"},"设置学习兴趣",ie().createElement("span",null,"已选择 ",t?t.length-1:0,"/",6," 个学院")),ie().createElement("div",null,n.map(((e,r)=>ie().createElement("ul",{className:"list",key:r},e.map((e=>ie().createElement("li",{className:"items",key:e.ID},ie().createElement("h4",{className:"item-title"},e.title),ie().createElement("ul",{className:"options"},e.children?.map((e=>ie().createElement("li",{className:"op "+(s(e)?"active":""),key:e.ID,onClick:r=>(e=>{let r=[...t],s=t.findIndex((t=>t.ID===e.ID));-1!==s?r.splice(s,1):r.length-1<6?r.push(e):alert("最多选择6个"),a(r)})(e)},e.title))))))))))),ie().createElement("div",{className:"btns"},ie().createElement("div",{className:"btn btn-default",onClick:e.onClose},"下次再选"),ie().createElement("div",{className:"btn btn-primary",onClick:a=>(t=>{const a=e.user?.token;a?e.dispatch(dt.user.submitMySubscribe(t)):alert("请登录后再设置"),e.onClose()})(t)},"保存"))))})),mt=(0,ue.connect)((e=>e))((function(e){const t=e.user?.mySubscribe,a=e.user?.myCurSubscribe,[r,s]=(0,ne.useState)(!1);return t||e.dispatch(dt.user.getMySubscribe()),t&&(t?.find((e=>e.ID===a))||e.dispatch(dt.user.setMyCurSubscribe(0))),ie().createElement(ie().Fragment,null,ie().createElement("div",{className:"subscribe"},ie().createElement("div",{className:"page"},ie().createElement("div",{className:"btn-container"},ie().createElement("span",{className:"btn",onClick:e=>s(!0)},"添加兴趣")))),r?ie().createElement(gt,{onClose:()=>s(!1)}):"")}));function Et(e){return`/course/${e}`}const pt=(0,ue.connect)((e=>e))((function(e){const{title:t,data:a}=e;return ie().createElement("div",{className:"course-list"},a?ie().createElement(ie().Fragment,null,t?ie().createElement("h3",{className:"cap"},t):"",ie().createElement("ul",{className:"page list"},a?.map((e=>ie().createElement("li",{className:"course",key:e.ID},ie().createElement("div",{className:"img"},ie().createElement("a",{href:Et(e.ID)},ie().createElement("img",{src:e.cover,alt:""}))),ie().createElement("h4",{className:"title"},ie().createElement("a",{href:Et(e.ID)},e.title)),ie().createElement("div",{className:"info"},ie().createElement("span",null,"共",e.section_count,"节"),ie().createElement("span",{className:"split"},"|"),ie().createElement("span",null,ie().createElement("a",{href:Et(e.ID)},e.agency_name))),ie().createElement("div",{className:"info2"},ie().createElement("span",{className:"price"},e.price?`￥${e.price}`:"免费"),ie().createElement("span",{className:"student"},e.recent_order_count,"人最近报名"))))))):"")})),bt=(0,ue.connect)((e=>e))((function(e){var t;e.appData&&(t=e.appData,le=t);const a=e.course?.indexCourseList;let r=[];return e.site.SubscribeData&&e.user.mySubscribe&&(r=function(e,t){let a=[],r=t.map((t=>{let a=e.find((e=>e.children?.find((e=>e.ID===t.ID))));return a?{category:a.ID,title:a.title}:null}));for(let e=0;e<r.length;e++)r[e]||(r.splice(e,1),e--);return r.forEach((e=>{a.find((t=>t.category===e.category))||a.push(e)})),a}(e.site.SubscribeData,e.user.mySubscribe)),a&&r.forEach((({category:t})=>{a[t]||e.dispatch(dt.course.getIndexCourseSummary(t))})),e.site.SubscribeData||e.dispatch(Pe()),ie().createElement("div",null,ie().createElement(yt,null),ie().createElement(mt,null),a?r.map((e=>ie().createElement(pt,{key:e.category,title:e.title,data:a[e.category]}))):"",ie().createElement("div",{className:"all-course page"},ie().createElement("a",{href:"/list"},"查看全部课程 >")))})),_t={myCurSubscribe:0},Dt=((0,de.createReducer)(_t,(e=>e.addCase(dt.user.setToken,((e,t)=>({...e,token:t.payload.token}))).addCase(dt.user.clearToken,(e=>{let t={...e};return delete t.token,t})).addCase(dt.user.setUserData,((e,t)=>({...e,userData:t.payload}))).addCase(dt.user.setMySubscribe,((e,t)=>({...e,mySubscribe:t.payload}))).addCase(dt.user.setMyCurSubscribe,((e,t)=>({...e,myCurSubscribe:t.payload}))).addCase(dt.user.setMyProgressInfo,((e,{payload:t})=>({...e,myProgressInfo:t}))).addCase(dt.user.setMyCourseList,((e,{payload:t})=>({...e,myCourseList:t}))).addCase(dt.user.setMyChapters,((e,{payload:t})=>({...e,myChapters:t}))).addCase(dt.user.setMyOrder,((e,{payload:t})=>({...e,myOrders:t}))))),{topics:le.topics,links:le.links}),St=((0,de.createReducer)(Dt,(e=>e.addCase(dt.site.setAllCategory,((e,t)=>({...e,CategoryData:t.payload}))).addCase(dt.site.setHotKeywords,((e,{payload:t})=>({...e,hotKeywords:t}))).addCase(dt.site.setAllBanner,((e,{payload:t})=>({...e,BannerData:t}))).addCase(dt.site.setSuggest,((e,{payload:t})=>({...e,suggest:t}))).addCase(dt.site.setAllSubscribeData,((e,t)=>({...e,SubscribeData:t.payload}))).addCase(dt.site.setTopics,((e,t)=>({...e,topics:t.payload}))).addCase(dt.site.setSiteLink,((e,t)=>({...e,links:t.payload}))))),{user:_t,site:Dt}),wt=(0,de.createReducer)(St,(e=>e)),It=(0,de.configureStore)({reducer:wt});let ht=new(p());ht.get("/",(async e=>{let t=u().readFileSync(f().resolve(A,"index.html")).toString(),a={categories:await F(),hotKeyWords:await Y(""),banners:await G(),topics:await X(),links:await Q()},r=oe().renderToString(ie().createElement(ue.Provider,{store:It},ie().createElement(bt,{appData:a}))),s=t.replace('<div id="root"></div>',`\n            <script>\n            window.appData=${JSON.stringify(a)}\n            <\/script>\n            <div id="root">${r}</div>`);e.body=s}));const ft=ht.routes(),At=new(p());At.use(se),At.use(ft),At.get("/oauth2.0/me",(async e=>{e.body=[{name:"banners"},{name:"users"}]}));const Ct=At.routes(),Rt=require("koa-static");var Nt=a.n(Rt);(function(e){e.use((async(e,t)=>{e.set("Access-Control-Allow-Origin","*"),e.set("Access-Control-Allow-Headers","*"),"OPTIONS"==e.method?e.body="OK":await t()}))})(m),m.use((async(e,t)=>{try{await t(),void 0===e.body&&(e.status=404,e.body="未找到数据")}catch(t){"number"==typeof t.code?(e.status=t.code,e.body=t.msg):(e.status=500,e.body="服务器错误，请刷新重试",function(e){let t=new Date,a=`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`;u().appendFile(C,`[${a}] ${e.stack}\n`,(()=>{}))}(t))}})),m.use(Ct),m.use(Nt()(A))})()})();