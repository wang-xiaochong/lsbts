(()=>{"use strict";var e={168:e=>{e.exports=require("koa-sslify")}},t={};function a(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,a),n.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={};a.r(e),a.d(e,{clearToken:()=>be,getMyChapters:()=>Te,getMyCourseList:()=>Ne,getMyOrder:()=>ke,getMyProgressInfo:()=>Ce,getMySubscribe:()=>Ie,getUserData:()=>Se,restoreToken:()=>_e,saveToken:()=>pe,setMyChapters:()=>ve,setMyCourseList:()=>Re,setMyCurSubscribe:()=>fe,setMyOrder:()=>Oe,setMyProgressInfo:()=>Ae,setMySubscribe:()=>we,setToken:()=>me,setUserData:()=>De,submitMySubscribe:()=>he});var t={};a.r(t),a.d(t,{getAllBanner:()=>qe,getAllCategory:()=>Le,getAllSubscribeData:()=>Ue,getHotKeywords:()=>We,getSiteLink:()=>Je,getSuggest:()=>xe,getTopics:()=>Be,setAllBanner:()=>Fe,setAllCategory:()=>Me,setAllSubscribeData:()=>$e,setHotKeywords:()=>He,setSiteLink:()=>Ye,setSuggest:()=>Pe,setTopics:()=>Ke});var r={};a.r(r),a.d(r,{hideAlert:()=>je,setFooterVisible:()=>Qe,setHeaderVisible:()=>Ge,setSearchBarKw:()=>ze,showAlert:()=>Ve});var s={};a.r(s),a.d(s,{addMyProgress:()=>gt,getAdList:()=>nt,getCourseDetail:()=>lt,getCourseRegisted:()=>ct,getIndexCourseSummary:()=>Ze,getSearchCategoryData:()=>rt,getSearchCourse:()=>tt,getVideoSectionData:()=>dt,registerCourse:()=>yt,setAdList:()=>st,setCourseDetail:()=>ot,setCourseRegisted:()=>it,setIndexCourseSummary:()=>Xe,setSearchCategoryData:()=>at,setSearchCourseResult:()=>et,setVideoSectionData:()=>ut});const n=require("koa");var i=a.n(n);const c=require("https");var o=a.n(c);const l=require("fs");var u=a.n(l);const d=a(168).default,y=new(i());y.use(d());var g={key:u().readFileSync("src/keys/private_key.pem"),cert:u().readFileSync("src/keys/ca-cert.pem")};o().createServer(g,y.callback()).listen(7070,(()=>{console.log("server start at localhost:7070")}));const E=y,m=require("@koa/router");var p=a.n(m);const _=require("mysql2/promise");const b=a.n(_)().createPool({host:"82.156.109.119",port:3306,user:"xiaoshuai",password:"DTxjyNCWjz5t8RDn",database:"lsbts"}),D=new class{db;constructor(e){this.db=e}async query(e,t){try{return(await this.db.query(e,t))[0]}catch(e){throw console.log(JSON.stringify(e)),e}}async execute(e,t){try{return(await this.db.execute(e,t))[0]}catch(e){console.log(e)}}async all(e,t,a){return t?await this.query("\n            SELECT * FROM ?? ORDER BY ?? "+("asc"==a?"ASC":"DESC"),[e,t,a]):await this.query("SELECT * FROM ??",[e])}async one(e,t){return(await this.query(e,t))[0]}async count(e,t,a){return a||(a=[]),t?await this.one(`SELECT COUNT(*) AS count FROM ?? WHERE ${t} `,[e,...a]):await this.one("SELECT COUNT(*) AS count FROM ??",[e])}}(b),S=require("redis");var w=a.n(S);const I=require("util"),h=require("path");var f=a.n(h);const A=f().resolve(__dirname,"../build"),C=f().resolve(__dirname,"../log/error.log"),R="KEY_APP_CATEGORY_CACHE",N="KEY_APP_ALL_SUBSCRIBE_CACHE",v="KEY_APP_TOPICS",T="KEY_APP_DEBOUNCE_PRE";let O=w().createClient({host:"82.156.109.119",port:6379,username:"xiaoshuai",password:"sdl@admin"});const k=(0,I.promisify)(O.get).bind(O),M=(0,I.promisify)(O.set).bind(O);async function L(e){{let t=await k(e);if(t)try{return JSON.parse(t)}catch(e){}}}async function F(e,t){await M(e,JSON.stringify(t))||console.error("SetRedisCache Failed!")}async function q(){let e=await L(R);if(e)return e;let t=[],a=await D.all("category_table","parent_id","asc"),r=await D.all("category_item_table","category_id","asc");return a.forEach((e=>{let a={ID:e.ID,title:e.title};const{parent_id:r}=e;if(0===r)t.push(a);else{let e=t.find((e=>e.ID===r));e&&(e.children=e.children||[],e.children.push(a))}})),r.forEach((e=>{let r={ID:e.ID,title:e.title};const{category_id:s}=e;t.forEach((e=>{let t=e.children?.find((e=>e.ID===s));t&&(t.children||(t.children=[]),t.children.push(r))}));{let e=a.find((e=>e.ID===s));if(e){let s=a.find((t=>t.ID===e?.parent_id)),n=t.find((e=>e.ID===s?.ID));n&&(n.items=n.items||[]),n?.items&&n?.items?.length<3&&n.items.push(r)}}})),await F(R,t),t}(0,I.promisify)(O.del).bind(O);let H=new(p());H.prefix("/category"),H.get("/getCategories",(async e=>{let t=await q();e.body=t}));const W=H.routes();function P(e){return new Promise(((t,a)=>{try{e.req.addListener("data",(e=>{var a=JSON.parse(e);t(a)}))}catch(e){a(e)}}))}async function x(e,t){return!!await L(T+e)||(await F(T+e,!0),t.body="Processing",!1)}async function $(e){await F(T+e,!1)}async function U(e,t){t||(t=0);const a=await D.query("SELECT * FROM course_chapter_table WHERE course_id=?",[e]),r=await D.query("\n    SELECT\n        section.*,progress.time\n    FROM\n        course_section_table AS section LEFT JOIN\n        course_progress_table AS progress ON progress.course_section_id=section.ID\n    WHERE\n    section.course_id=?",[e]),s=await D.query("SELECT * FROM course_progress_table WHERE course_id=? AND user_id=?",[e,t]),n=[];a.forEach((e=>{n.push({ID:e.ID,progress:0,title:e.title,sections:[]})}));let i={};r.forEach((({item_id:e,type:t})=>{i[t]||(i[t]=[]),i[t].push(e)}));let c={video:"ID,videoID,duration",live:"ID,liveID,start_time,end_time",read:"ID",download:"ID,fileID,size"},o={};for(let e in i)o[e]=await D.query(`SELECT ${c[e]} FROM course_${e}_table WHERE ID IN (${i[e].join(",")})`);return r.forEach((({ID:e,title:t,type:a,item_id:r,chapter_id:i,time:c})=>{let l=n.find((e=>e.ID===i)),u=o[a].find((e=>e.ID===r));if(l){let r=0;if("video"===a){let t=s.find((t=>t.course_section_id===e));t&&u&&(r=Math.min(1,Math.round(100*t.progress/u.duration)/100))}else r=1;l.sections.push({ID:e,title:t,type:a,progress:r,item:u,time:c})}})),n.forEach((e=>{let t=0;e.sections.forEach((e=>{t+=e.progress})),e.progress=Math.min(1,Math.round(100*t/e.sections.length)/100)})),n}const K=require("crypto");var B=a.n(K);function Y(e,t,a){if(e)throw{code:t,msg:a}}const J=require("url");var V=a.n(J);async function j(e,t){let{count:a}=await D.one("\n     SELECT COUNT(*) AS count FROM pay_table WHERE course_id=? AND user_id=?\n     ",[e,t]);return a>0}async function z(e){return(await D.query("\n    SELECT \n    keyword \n    FROM search_record_table \n    WHERE keyword LIKE ?\n    ORDER BY count DESC\n    LIMIT 5",[e+"%"])).map((e=>e.keyword))}async function G(e){if(e){return(await D.one("SELECT ID FROM user_table WHERE token=?",[e])).ID||0}return 0}let Q=new(p());Q.prefix("/course"),Q.get("/index-course-list",(async e=>{const{category:t}=e.query;"string"==typeof t&&(e.body=await async function(e,t){return await D.query("\n   SELECT \n        course.ID, course.title,course.cover,course.price,course.agency_id,\n        agency.name AS agency_name,\n        0 AS recent_order_count,\n        0 AS section_count\n   FROM \n        course_table AS course LEFT JOIN\n        agency_table AS agency ON course.agency_id=agency.ID\n    WHERE\n        category_id_1=?\n\n   LIMIT\n        20\n   ",[e])}(parseInt(t)))})),Q.get("/get-category-options",(async e=>{let t=e.query.category?Number(e.query.category):0,a=e.query.category_level?Number(e.query.category_level):0;e.body=t&&a?await async function(e,t){return Y("number"!=typeof e,400,"request arguments invaild 1"),Y("number"!=typeof t,400,"request arguments invaild 2"),Y(1!=t&&2!=t&&3!=t,400,"request arguments invaild 3"),(await D.query("\n      SELECT * FROM\n        category_tags_table\n      WHERE\n        category_id=? AND category_level=?\n      ORDER BY\n        sort ASC\n    ",[e,t])).map((e=>({key:e.ID,title:e.title,options:e.options.split(","),allow_multi:1==e.allow_multi})))}(t,a):[]})),Q.post("/search",(async e=>{var t=await P(e);e.body=await async function(e){const t="KEY_APP_SEARCH_PRE_"+JSON.stringify(e);let a=await L(t);if(a)return a;const{category:r,category_level:s,keyword:n,page:i,categories:c}=e;let o=[];if(r&&s&&"0"!=r.toString()&&"0"!=s.toString()&&o.push(`category_id_${s}=${r}`),n){let e=n.split(/\s+/),t=[];e.forEach((e=>{t.push(`title LIKE '%${e}%'`)})),o.push("("+t.join(" OR ")+")")}const{filter:l}=e,{type:u,sort:d}=l;"free"===u?o.push("price=0"):u&&o.push("price>0");let y=o.join(" AND "),g="";y&&(g=` WHERE ${y}`);let E="";"default"!==d&&"students"!==d&&(E="rank"===d?` ORDER BY course.${d} DESC`:` ORDER BY ${d} DESC`);let m=`\n    SELECT \n         course.ID, course.title,course.cover,course.price,course.agency_id,tags,\n         agency.name AS agency_name,\n         0 AS recent_order_count,\n         0 AS section_count\n    FROM \n         course_table AS course LEFT JOIN\n         agency_table AS agency ON course.agency_id=agency.ID\n         ${g} \n         ${E}\n         `,p=await D.query(m);p=p.filter((e=>{let t=JSON.parse(e.tags),a={};for(let e in t)a[e]=t[e].split(",");return function(e,t){for(let a in e){if(!t[a])return!1;for(let r=0;r<e[a].length;r++){let s=e[a][r];if(-1===t[a].indexOf(s))return!1}}return!0}(c,a)}));let _=p.length,b=24*(i-1),S={data:p.slice(b,24),total:_};return await F(t,S),S}(t)})),Q.get("/ad",(async e=>{const{type:t}=e.query;let a;"right"!==t&&"bottom"!==t||(a=await async function(e){return await D.query("\n    SELECT\n        course.ID,course.title,course.cover,course.price,\n        course.agency_id,agency.name AS agency_name\n    FROM\n        ad_table AS ad\n        LEFT JOIN course_table AS course\n            ON ad.course_id=course.ID\n        LEFT JOIN agency_table AS agency\n            ON course.agency_id=agency.ID\n    WHERE\n        ad.type=?\n    ",[e])}(t)),e.body={type:t,data:a}})),Q.get("/is-registed/:courseID",(async e=>{const t=await G(e.get("token")),a=Number(e.params.courseID);e.body=await j(a,t)})),Q.get("/detail/:courseID",(async e=>{const t=Number(e.params.courseID);let a=await async function(e){const t="KEY_COURSE_DETAIL_PRE"+e;let a=await L(t);if(a)return a;const r=await D.one("SELECT * FROM course_table WHERE ID=?",[e]),s={ID:r.ID,cover:r.cover,title:r.title,price:r.price,total_students:0,recently_students:0,rank:r.rank,summary:r.summary,description:r.description},n=(await D.query(`SELECT * FROM teacher_table WHERE ID IN (${r.teachers})`)).map((({ID:e,name:t,title:a,summary:r,avatar:s})=>({ID:e,name:t,title:a,summary:r,avatar:s}))),i=await D.one("SELECT * FROM category_table WHERE ID=?",[r.category_id_1]),c=await D.one("SELECT * FROM category_table WHERE ID=?",[r.category_id_2]),o=await D.one("SELECT * FROM category_item_table WHERE ID=?",[r.category_id_3]),l=[{ID:r.category_id_1,title:i.title},{ID:r.category_id_2,title:c.title},{ID:r.category_id_3,title:o.title}],u=await D.one("SELECT * FROM agency_table WHERE ID=?",[r.agency_id]),{count:d}=await D.count("course_table","agency_id=?",[u.ID]),{count:y}=await D.count("pay_table","agency_id=?",[u.ID]);return a={course:s,teachers:n,category:l,agency:{avatar:u.logo,agency_name:u.name,agency_rank:u.rank,summary:u.summary,total_course:d,total_students:y},chapters:await U(e),comments:(await D.query("SELECT * FROM course_comment_table WHERE course_id=?",[e])).map((({ID:e,rank:t,time:a,course_time:r,content:s,avatar:n,nickname:i})=>({ID:e,rank:t,time:a,course_time:r,content:s,avatar:n,nickname:i})))},await F(t,a),a}(t);e.body=a})),Q.get("/video-section/:sectionID",(async e=>{const t=Number(e.params.sectionID),a=await G(e.get("token"));e.body=await async function(e,t){const a=await D.one("SELECT * FROM course_section_table WHERE type=? AND ID=?",["video",e]);Y(!a,404,"请先观看录播视频"),Y(!await j(a.course_id,t),403,"需要报名课程后查看");const r=await D.one("SELECT * FROM course_video_table WHERE ID=?",[a.item_id]);Y(!r,404,"视频不存在或已被删除");const{videoID:s,duration:n}=r,i=Math.floor(Date.now()/1e3+2*n).toString(16),c=(o=f().parse(V().parse(s).path||"").dir+"/"+i,B().createHash("md5").update(o).digest("hex"));var o;return{section_title:a.title,videoLink:`${s}?t=${i}&sign=${c}`}}(t,a)})),Q.get("/regist/:courseID",(async e=>{const t=Number(e.params.courseID),a=await G(e.get("token"));await async function(e,t){let a=await D.one("SELECT * FROM course_table WHERE ID=?",[e]);Y(!a,400,"报名的课程不存在，请刷新重试"),Y(!await D.count("user_table","ID=?",[t]),400,"用户数据有误，请重新登录");let{count:r}=await D.count("pay_table","course_id=? AND user_id=? AND status='success'",[e,t]);Y(0!==r,400,"已报名过，请勿重复报名"),await D.query("\n       INSERT INTO pay_table\n       (order_id, serial_number, time, status, agency_id, course_id, user_id, amount)\n       VALUES('0', '0', ?, 'success', ?, ?, ?, ?)\n       ",[Math.floor(Date.now()/1e3),a.agency_id,e,t,a.price])}(t,a),e.body="ok"})),Q.get("/add-progress/:sectionID",(async e=>{const t=Number(e.params.sectionID),a=await G(e.get("token"));await async function(e,t){let a=await D.one("SELECT * FROM course_section_table WHERE ID=?",[e]);Y(!a,400,"章节不存在，请刷新重试"),Y(!("video"===a.type),400,"视频类型有误，请刷新重试"),Y(!await D.one("SELECT * FROM pay_table WHERE course_id=? AND user_id=?",[a.course_id,t]),400,"此课程未报名，请报名后重试");let r=await D.one("SELECT * FROM course_progress_table WHERE course_section_id=? AND user_id=?",[e,t]);r?await D.query("UPDATE course_progress_table SET progress=progress+30 WHERE ID=?",[r.ID]):await D.query("\n         INSERT INTO course_progress_table\n         (\n           user_id, course_id, course_chapter_id, course_section_id, progress, time\n         )\n         VALUE(\n           ?, ?, ?, ?, ?, ?\n         )\n         ",[t,a.course_id,a.chapter_id,e,30,Math.floor(Date.now()/1e3)]);let s=new Date,n=Number(s.getFullYear()+(s.getMonth()+1).toString().padStart(2,"0")+s.getDate().toString().padStart(2,"0")),i=await D.one("SELECT * FROM user_points_table WHERE user_id=? AND date=?",[t,n]);if(i){let e=Math.min(50,(i.studyTime+30)/120),a=e-i.points;await D.query("UPDATE user_points_table SET studyTime=studyTime+30, points=? WHERE ID=?",[e,i.ID]),a&&await D.query("UPDATE user_table SET points=points+? WHERE ID=?",[a,t])}else{let e=Math.floor(.25);await D.query("INSERT INTO user_points_table (user_id, date, studyTime, points) VALUE(?,?,?,?)",[t,n,30,e]),e&&await D.query("UPDATE user_table SET points=points+? WHERE ID=?",[e,t])}}(t,a),e.body="ok"}));const X=Q.routes();async function Z(){return await D.all("banner_table","sort","asc")}async function ee(){let e=await L("KEY_APP_SITELINK");return e||(e=(await D.all("site_link_table","sort","asc")).map((e=>({ID:e.ID,title:e.title,href:e.href}))),e)}async function te(){let e=await L(v);if(e)return e;let t=await D.all("topic_table","sort","asc"),a=await D.all("topic_item_table","sort","asc");return e=t.map((e=>({ID:e.ID,title:e.title,children:[]}))),a.forEach((t=>{let a=e.find((e=>e.ID===t.topic_id));a&&a.children?.push({ID:t.ID,title:t.title})})),F(v,e),e}let ae=new(p());ae.prefix("/site"),ae.get("/getCategories",(async e=>{let t=await q();e.body=t})),ae.get("/getHotKeyWords",(async e=>{let t=await z("");e.body=t})),ae.get("/getSuggest/:kw",(async e=>{const{kw:t}=e.params;let a=await z(t);e.body=a})),ae.get("/getAllBanners",(async e=>{let t=await Z();e.body=t})),ae.get("/getAllSubscibe",(async e=>{let t=await async function(){let e=await L(N);return e||(e=[],(await D.all("category_table","parent_id","asc")).forEach((t=>{0==t.parent_id?e.push({ID:t.ID,title:t.title,children:[]}):e.find((e=>e.ID==t.parent_id))?.children?.push({ID:t.ID,title:t.title})}))),await F(N,e),e}();e.body=t})),ae.get("/getTopics",(async e=>{let t=await te();e.body=t})),ae.get("/getSiteLink",(async e=>{let t=await ee();e.body=t}));const re=ae.routes();let se=new(p());se.prefix("/user"),se.get("/userCheck",(async e=>{const t=e.URL.searchParams.get("openID");if(t){let a=await async function(e){let t=await D.query("\n    SELECT \n    user_id\n    FROM qq_user_table \n    WHERE open_id=?\n    ",[e]);return t.length>0?{user_id:t[0].user_id}:{user_id:-1}}(t);e.body=a}else e.body="NO OPENID"})),se.post("/update",(async e=>{var t=await P(e);if(!t||!await x(String(t.user_id),e)){if(t){let a=await async function(e,t){return!!await D.execute("\n    UPDATE user_table\n    SET nickname=?,avatar=?,token=?\n    WHERE ID=?\n    ",[e.nickname,e.avatar,e.token,t])}(t.userdata,t.user_id);e.body=a}else e.body=!1;await $(String(t.user_id))}})),se.post("/add",(async e=>{var t=await P(e);if(!t||!await x(String(t.openID),e)){if(t){let a=await async function(e,t){await D.execute("\n    INSERT INTO user_table\n    (nickname,avatar,token,qq_unionid,points,currency,mobile,address,blocked)\n    VALUES \n    (?,?,?,'',0,0,'','',0)\n    ",[e.nickname,e.avatar,e.token]);let{ID:a}=(await D.query("SELECT ID FROM user_table WHERE token=?",[e.token]))[0];return!!await D.execute("\n    INSERT INTO qq_user_table\n    (user_id,open_id)\n    VALUES \n    (?,?)\n    ",[a,t])}(t.userdata,t.openID);e.body=a}else e.body=!1;await $(String(t.openID))}})),se.get("/getUserInfo",(async e=>{const t=e.get("token");if(t){let a=await async function(e){return(await D.query("\n    SELECT \n    ID,avatar,nickname,points,currency\n    FROM user_table \n    WHERE token=?\n    ",[e]))[0]}(t);a?e.body=a:(e.status=404,e.body="Not Found")}else e.body=""})),se.get("/mysubscribe",(async e=>{let t=await G(e.get("token"));e.body=await async function(e){let t=await D.one("SELECT * FROM user_subscribe_table WHERE user_id=?",[e]),a=[{ID:0,title:"精选推荐"}];if(t){let e=JSON.parse(t.category_id);for(let t=0;t<e.length;t++){let r=await D.query("SELECT ID,title FROM category_table WHERE ID=?",e[t]);a.push(r[0])}}else a.push({ID:2,title:"前端"},{ID:3,title:"后端"},{ID:8,title:"面试求职"});return a}(t)})),se.post("/setMysubscribe",(async e=>{let t=await G(e.get("token"));var a=await P(e);await async function(e,t){Y(!e,401,"请先登录再设置"),Y(!await D.one("SELECT * FROM user_table WHERE ID=?",[e]),400,"数据异常请重新登录"),Y(!(t instanceof Array),400,"数据异常刷新重试");{let a,r=[];for(let e=1;e<t.length;e++)r.push(t[e].ID);a=await D.one("SELECT * FROM user_subscribe_table WHERE user_id=?",[e])?await D.execute("\n    UPDATE  user_subscribe_table\n    SET category_id=?\n    WHERE user_id=?\n    ",[r,e]):await D.execute("\n    INSERT INTO user_subscribe_table\n    (user_id,category_id)\n    VALUES \n    (?,?)\n    ",[e,r])}}(t,a),e.body="OK"})),se.get("/my-progress-info",(async e=>{let t=await G(e.get("token"));e.body=await async function(e){let t=new Date,a=Number(t.getFullYear()+(t.getMonth()+1).toString().padStart(2,"0")+t.getDate().toString().padStart(2,"0"));const{points:r}=await D.one("SELECT points FROM user_table WHERE ID=?",[e]),s=await D.one("SELECT studyTime,points FROM user_points_table WHERE user_id=? AND date=?",[e,a]);let n=0,i=0;s&&(n=s.studyTime,i=s.points);const{count:c}=await D.one("SELECT COUNT(*) AS count  FROM user_points_table WHERE studyTime>? AND date=?",[n,a]),{count:o}=await D.count("user_table");return{points:r,todayCourseRank:Math.round((o-c)/o*1e3)/1e3,todayPoints:i,todayCourseSec:n}}(t)})),se.get("/my-course-list",(async e=>{let t=await G(e.get("token"));e.body=await async function(e){return await D.query("\n    SELECT\n        course.ID,course.title,course.expires,\n        0 AS progress\n    FROM\n        pay_table AS pay LEFT JOIN\n        course_table AS course ON pay.course_id=course.ID\n    WHERE\n        pay.status='success' AND pay.user_id=?\n    ",[e])}(t)})),se.get("/chapters/:courseID",(async e=>{let t=await G(e.get("token")),a=Number(e.params.courseID);e.body=await U(a,t)})),se.get("/my-orders",(async e=>{let t=await G(e.get("token"));e.body=await async function(e){return(await D.query("\n        SELECT\n          pay.ID,\n          pay.time,\n          agency.name AS agency_name,\n  \n          course.ID AS course_id,\n          course.cover,\n          course.title,\n          '' AS className,\n          course.price,\n          pay.status\n        FROM\n          pay_table AS pay LEFT JOIN\n          agency_table AS agency ON pay.agency_id=agency.ID LEFT JOIN\n          course_table AS course ON pay.course_id=course.ID\n        WHERE\n          pay.user_id=?\n  \n        ORDER BY pay.time DESC\n      ",[e])).map((e=>({ID:e.ID,time:e.time,agency_name:e.agency_name,courses:[{ID:e.course_id,cover:e.cover,title:e.title,className:e.className,price:e.price,status:e.status}]})))}(t)}));const ne=se.routes();let ie=new(p());ie.prefix("/api"),ie.get("/getAPI",(async e=>{e.body=[{name:"banners"},{name:"users"}]})),ie.use(W),ie.use(X),ie.use(re),ie.use(ne);const ce=ie.routes(),oe=require("react");var le=a.n(oe);const ue=require("react-dom/server");var de=a.n(ue);let ye;ye="undefined"!=typeof window?window.appData:{};const ge=require("react-redux"),Ee=require("@reduxjs/toolkit"),me=(0,Ee.createAction)("setToken"),pe=(0,Ee.createAction)("saveToken"),_e=(0,Ee.createAction)("restoreToken"),be=(0,Ee.createAction)("clearToken"),De=(0,Ee.createAction)("setUserData"),Se=(0,Ee.createAction)("getUserData"),we=(0,Ee.createAction)("setMySubscribe"),Ie=(0,Ee.createAction)("getMySubscribe"),he=(0,Ee.createAction)("submitMySubscribe"),fe=(0,Ee.createAction)("setMyCurSubscribe"),Ae=(0,Ee.createAction)("setMyProgressInfo"),Ce=(0,Ee.createAction)("getMyProgressInfo"),Re=(0,Ee.createAction)("setMyCourseList"),Ne=(0,Ee.createAction)("getMyCourseList"),ve=(0,Ee.createAction)("setMyChapters"),Te=(0,Ee.createAction)("getMyChapters"),Oe=(0,Ee.createAction)("setMyOrder"),ke=(0,Ee.createAction)("getMyOrder"),Me=(0,Ee.createAction)("setAllCategory"),Le=(0,Ee.createAction)("getAllCategory"),Fe=(0,Ee.createAction)("setAllBanner"),qe=(0,Ee.createAction)("getAllBanner"),He=(0,Ee.createAction)("setHotKeywords"),We=(0,Ee.createAction)("getHotKeywords"),Pe=(0,Ee.createAction)("setSuggest"),xe=(0,Ee.createAction)("getSuggest"),$e=(0,Ee.createAction)("setAllSubscribeData"),Ue=(0,Ee.createAction)("getAllSubscribeData"),Ke=(0,Ee.createAction)("setTopics"),Be=(0,Ee.createAction)("getTopics"),Ye=(0,Ee.createAction)("setSiteLink"),Je=(0,Ee.createAction)("getSiteLink"),Ve=(0,Ee.createAction)("showAlert"),je=(0,Ee.createAction)("hideAlert"),ze=(0,Ee.createAction)("setSearchBarKw"),Ge=(0,Ee.createAction)("setHeaderVisible"),Qe=(0,Ee.createAction)("setFooterVisible"),Xe=(0,Ee.createAction)("setIndexCourseSummary"),Ze=(0,Ee.createAction)("getIndexCourseSummary"),et=(0,Ee.createAction)("setSearchCourseResult"),tt=(0,Ee.createAction)("getSearchCourse"),at=(0,Ee.createAction)("setSearchCategoryData"),rt=(0,Ee.createAction)("getSearchCategoryData"),st=(0,Ee.createAction)("setAdList"),nt=(0,Ee.createAction)("getAdList"),it=(0,Ee.createAction)("setCourseRegisted"),ct=(0,Ee.createAction)("getCourseRegisted"),ot=(0,Ee.createAction)("setCourseDetail"),lt=(0,Ee.createAction)("getCourseDetail"),ut=(0,Ee.createAction)("setVideoSectionData"),dt=(0,Ee.createAction)("getVideoSectionData"),yt=(0,Ee.createAction)("registerCourse"),gt=(0,Ee.createAction)("addProgress"),Et={user:e,site:t,app:r,course:s},mt=(0,ge.connect)((e=>e))((function(e){const t=ye.banners||e.site.BannerData,[a,r]=(0,oe.useState)(0);return t||e.dispatch(Et.site.getAllBanner()),le().createElement("div",{className:"banner",style:{backgroundColor:t?t[a].color:"#000"}},le().createElement("div",{className:"page"},le().createElement("div",{className:"content"},le().createElement("span",{className:"btn btn-prev",onClick:()=>{t&&r(0===a?t.length-1:a-1)}},le().createElement("i",{className:"icon icon-left-w"})),le().createElement("span",{className:"btn btn-next",onClick:()=>{t&&r(a===t.length-1?0:a+1)}},le().createElement("i",{className:"icon icon-right-w"})),t?le().createElement(le().Fragment,null,le().createElement("ul",{className:"banner-list"},t.map(((e,t)=>le().createElement("li",{key:e.ID,className:t===a?"active":""},le().createElement("a",{href:e.href},le().createElement("img",{src:e.img,alt:""})))))),le().createElement("ol",{className:"indicator-list"},t.map(((e,t)=>le().createElement("li",{key:e.ID,className:t===a?"active":""}))))):""),le().createElement("div",{className:"user"},le().createElement("div",{className:"no-user"},le().createElement("div",{className:"title"},"跟进你的学习进度"),le().createElement("div",{className:"img"})),le().createElement("div",{className:"login"},le().createElement("a",{className:"btn-login",href:"https://graph.qq.com/oauth2.0/show?which=Login&display=pc&client_id=101995223&response_type=token&scope=all&redirect_uri=https%3A%2F%2Fxscloud.ltd%2Fgames"},"登录")))))})),pt=(0,ge.connect)((e=>e))((function(e){const[t,a]=(0,oe.useState)(e.user?.mySubscribe?[...e.user?.mySubscribe]:[]),r=e.site?.SubscribeData;r||e.dispatch(Et.site.getAllSubscribeData()),t||e.dispatch(Et.user.getMySubscribe());const s=e=>!!t&&t.find((t=>t.ID===e.ID)),n=[[],[]];return r?.forEach(((e,t)=>{n[t%2].push(e)})),le().createElement(le().Fragment,null,le().createElement("div",{className:"g-subscribe-shadow",onClick:e.onClose}),le().createElement("div",{className:"g-subscribe-dialog"},le().createElement("h3",{className:"title"},"设置学习兴趣",le().createElement("span",null,"已选择 ",t?t.length-1:0,"/",6," 个学院")),le().createElement("div",null,n.map(((e,r)=>le().createElement("ul",{className:"list",key:r},e.map((e=>le().createElement("li",{className:"items",key:e.ID},le().createElement("h4",{className:"item-title"},e.title),le().createElement("ul",{className:"options"},e.children?.map((e=>le().createElement("li",{className:"op "+(s(e)?"active":""),key:e.ID,onClick:r=>(e=>{let r=[...t],s=t.findIndex((t=>t.ID===e.ID));-1!==s?r.splice(s,1):r.length-1<6?r.push(e):alert("最多选择6个"),a(r)})(e)},e.title))))))))))),le().createElement("div",{className:"btns"},le().createElement("div",{className:"btn btn-default",onClick:e.onClose},"下次再选"),le().createElement("div",{className:"btn btn-primary",onClick:a=>(t=>{const a=e.user?.token;a?e.dispatch(Et.user.submitMySubscribe(t)):alert("请登录后再设置"),e.onClose()})(t)},"保存"))))})),_t=(0,ge.connect)((e=>e))((function(e){const t=e.user?.mySubscribe,a=e.user?.myCurSubscribe,[r,s]=(0,oe.useState)(!1);return t||e.dispatch(Et.user.getMySubscribe()),t&&(t?.find((e=>e.ID===a))||e.dispatch(Et.user.setMyCurSubscribe(0))),le().createElement(le().Fragment,null,le().createElement("div",{className:"subscribe"},le().createElement("div",{className:"page"},le().createElement("ul",{className:"list"},t?.map((t=>le().createElement("li",{key:t.ID,className:a===t.ID?"active":"",onClick:()=>{e.dispatch(Et.user.setMyCurSubscribe(t.ID))}},t.title)))),le().createElement("div",{className:"btn-container"},le().createElement("span",{className:"btn",onClick:e=>s(!0)},"添加兴趣")))),r?le().createElement(pt,{onClose:()=>s(!1)}):"")}));function bt(e){return`/course/${e}`}const Dt=(0,ge.connect)((e=>e))((function(e){const{title:t,data:a}=e;return le().createElement("div",{className:"course-list"},a?le().createElement(le().Fragment,null,t?le().createElement("h3",{className:"cap"},t):"",le().createElement("ul",{className:"page list"},a?.map((e=>le().createElement("li",{className:"course",key:e.ID},le().createElement("div",{className:"img"},le().createElement("a",{href:bt(e.ID)},le().createElement("img",{src:e.cover,alt:""}))),le().createElement("h4",{className:"title"},le().createElement("a",{href:bt(e.ID)},e.title)),le().createElement("div",{className:"info"},le().createElement("span",null,"共",e.section_count,"节"),le().createElement("span",{className:"split"},"|"),le().createElement("span",null,le().createElement("a",{href:bt(e.ID)},e.agency_name))),le().createElement("div",{className:"info2"},le().createElement("span",{className:"price"},e.price?`￥${e.price}`:"免费"),le().createElement("span",{className:"student"},e.recent_order_count,"人最近报名"))))))):"")})),St=(0,ge.connect)((e=>e))((function(e){var t;e.appData&&(t=e.appData,ye=t);const a=e.course?.indexCourseList;let r=[];return e.site.SubscribeData&&e.user.mySubscribe&&(r=function(e,t){let a=[],r=t.map((t=>{let a=e.find((e=>e.children?.find((e=>e.ID===t.ID))));return a?{category:a.ID,title:a.title}:null}));for(let e=0;e<r.length;e++)r[e]||(r.splice(e,1),e--);return r.forEach((e=>{a.find((t=>t.category===e.category))||a.push(e)})),a}(e.site.SubscribeData,e.user.mySubscribe)),a&&r.forEach((({category:t})=>{a[t]||e.dispatch(Et.course.getIndexCourseSummary(t))})),e.site.SubscribeData||e.dispatch(Ue()),le().createElement("div",null,le().createElement(mt,null),le().createElement(_t,null),a?r.map((e=>le().createElement(Dt,{key:e.category,title:e.title,data:a[e.category]}))):"",le().createElement("div",{className:"all-course page"},le().createElement("a",{href:"/list"},"查看全部课程 >")))})),wt={myCurSubscribe:0},It=((0,Ee.createReducer)(wt,(e=>e.addCase(Et.user.setToken,((e,t)=>({...e,token:t.payload.token}))).addCase(Et.user.clearToken,(e=>{let t={...e};return localStorage.removeItem("token"),delete t.token,t})).addCase(Et.user.setUserData,((e,t)=>({...e,userData:t.payload}))).addCase(Et.user.setMySubscribe,((e,t)=>({...e,mySubscribe:t.payload}))).addCase(Et.user.setMyCurSubscribe,((e,t)=>({...e,myCurSubscribe:t.payload}))).addCase(Et.user.setMyProgressInfo,((e,{payload:t})=>({...e,myProgressInfo:t}))).addCase(Et.user.setMyCourseList,((e,{payload:t})=>({...e,myCourseList:t}))).addCase(Et.user.setMyChapters,((e,{payload:t})=>({...e,myChapters:t}))).addCase(Et.user.setMyOrder,((e,{payload:t})=>({...e,myOrders:t}))))),{topics:ye.topics,links:ye.links}),ht=((0,Ee.createReducer)(It,(e=>e.addCase(Et.site.setAllCategory,((e,t)=>({...e,CategoryData:t.payload}))).addCase(Et.site.setHotKeywords,((e,{payload:t})=>({...e,hotKeywords:t}))).addCase(Et.site.setAllBanner,((e,{payload:t})=>({...e,BannerData:t}))).addCase(Et.site.setSuggest,((e,{payload:t})=>({...e,suggest:t}))).addCase(Et.site.setAllSubscribeData,((e,t)=>({...e,SubscribeData:t.payload}))).addCase(Et.site.setTopics,((e,t)=>({...e,topics:t.payload}))).addCase(Et.site.setSiteLink,((e,t)=>({...e,links:t.payload}))))),{user:wt,site:It}),ft=(0,Ee.createReducer)(ht,(e=>e)),At=(0,Ee.configureStore)({reducer:ft});let Ct=new(p());Ct.get("/",(async e=>{let t=u().readFileSync(f().resolve(A,"index.html")).toString(),a={categories:await q(),hotKeyWords:await z(""),banners:await Z(),topics:await te(),links:await ee()},r=de().renderToString(le().createElement(ge.Provider,{store:At},le().createElement(St,{appData:a}))),s=t.replace('<div id="root"></div>',`\n            <script>\n            window.appData=${JSON.stringify(a)}\n            <\/script>\n            <div id="root">${r}</div>`);e.body=s}));const Rt=Ct.routes(),Nt=new(p());Nt.use(ce),Nt.use(Rt),Nt.get("/oauth2.0/me",(async e=>{e.body=[{name:"banners"},{name:"users"}]}));const vt=Nt.routes(),Tt=require("koa-static");var Ot=a.n(Tt);(function(e){e.use((async(e,t)=>{e.set("Access-Control-Allow-Origin","*"),e.set("Access-Control-Allow-Headers","*"),"OPTIONS"==e.method?e.body="OK":await t()}))})(E),E.use((async(e,t)=>{try{await t(),void 0===e.body&&(e.status=404,e.body="未找到数据")}catch(t){"number"==typeof t.code?(e.status=t.code,e.body=t.msg):(e.status=500,e.body="服务器错误，请刷新重试",function(e){let t=new Date,a=`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`;u().appendFile(C,`[${a}] ${e.stack}\n`,(()=>{}))}(t))}})),E.use(vt),E.use(Ot()(A))})()})();